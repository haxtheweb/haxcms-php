define(["meta","require","../../../@polymer/polymer/polymer-legacy.js","../../beaker-broker/beaker-broker.js","../../../@polymer/polymer/lib/utils/resolve-url.js"],function(meta,_require,_polymerLegacy,_beakerBroker,_resolveUrl){"use strict";meta=babelHelpers.interopRequireWildcard(meta);_require=babelHelpers.interopRequireWildcard(_require);var _Mathfloor=Math.floor;function _templateObject_3b602c10149211e9b902f3f496e8b6e3(){var data=babelHelpers.taggedTemplateLiteral(["\n    <beaker-broker id=\"beaker\"></beaker-broker>\n  "]);_templateObject_3b602c10149211e9b902f3f496e8b6e3=function(){return data};return data}(0,_polymerLegacy.Polymer)({is:"haxcms-backend-beaker",_template:(0,_polymerLegacy.html)(_templateObject_3b602c10149211e9b902f3f496e8b6e3()),properties:{jwt:{type:String},manifest:{type:Object},activeItem:{type:Object}},created:function created(){document.body.addEventListener("jwt-token",this._jwtTokenFired.bind(this));document.body.addEventListener("json-outline-schema-active-item-changed",this.initialItem.bind(this));document.body.addEventListener("json-outline-schema-active-body-changed",this.initialBody.bind(this));document.body.addEventListener("haxcms-save-site-data",this.saveManifest.bind(this));document.body.addEventListener("haxcms-save-outline",this.saveOutline.bind(this));document.body.addEventListener("haxcms-save-page",this.savePage.bind(this));document.body.addEventListener("hax-app-picker-selection",this._appPicked.bind(this))},detached:function detached(){document.body.removeEventListener("jwt-token",this._jwtTokenFired.bind(this));document.body.removeEventListener("json-outline-schema-active-item-changed",this.initialItem.bind(this));document.body.removeEventListener("json-outline-schema-active-body-changed",this.initialBody.bind(this));document.body.removeEventListener("haxcms-save-site-data",this.saveManifest.bind(this));document.body.removeEventListener("haxcms-save-outline",this.saveOutline.bind(this));document.body.removeEventListener("haxcms-save-page",this.savePage.bind(this));document.body.removeEventListener("hax-app-picker-selection",this._appPicked.bind(this))},_appPicked:function _appPicked(e){var _this=this;if("dat"===e.detail.connection.protocol){e.preventDefault();e.stopPropagation();var reader=new FileReader;reader.onload=function(event){var fileLocation="files/"+window.HaxStore.instance.haxManager.$.fileupload.files[0].name;_this.$.beaker.write(fileLocation,event.target.result);window.HaxStore.instance.haxManager.$.url.value=fileLocation;window.HaxStore.instance.haxManager.newAssetConfigure()};reader.readAsArrayBuffer(window.HaxStore.instance.haxManager.$.fileupload.files[0])}},initialItem:function initialItem(e){this.activeItem=e.detail;this.__item=e.detail},initialManifest:function initialManifest(e){this.manifest=e.detail;this.__manifest=e.detail},initialBody:function initialBody(e){this.__body=e.detail},savePage:function(){var _savePage=babelHelpers.asyncToGenerator(regeneratorRuntime.mark(function _callee(e){return regeneratorRuntime.wrap(function(_context){while(1){switch(_context.prev=_context.next){case 0:this.activeItem=e.detail;_context.next=3;return this.$.beaker.write(this.activeItem.location,window.HaxStore.instance.activeHaxBody.haxToContent());case 3:window.cmsSiteEditor.instance.haxCmsSiteEditorElement.$.toast.show("Page updated!");window.cmsSiteEditor.instance.haxCmsSiteEditorElement.fire("haxcms-trigger-update-page",!0);case 5:case"end":return _context.stop();}}},_callee,this)}));return function savePage(){return _savePage.apply(this,arguments)}}(),saveOutline:function(){var _saveOutline=babelHelpers.asyncToGenerator(regeneratorRuntime.mark(function _callee2(e){var _this2=this;return regeneratorRuntime.wrap(function(_context2){while(1){switch(_context2.prev=_context2.next){case 0:this.manifest=window.cmsSiteEditor.instance.haxCmsSiteEditorElement.manifest;this.manifest.items=e.detail;this.manifest.items.forEach(function(element,index){if(babelHelpers.typeof(element.location)==="undefined"){var id=_this2.generateResourceID("item-");element.id=id;element.location="pages/"+id+"/index.html";element.order=index;element.description="";element.metadata={created:_Mathfloor(Date.now()/1e3),updated:_Mathfloor(Date.now()/1e3)};_this2.$.beaker.archive.mkdir("pages/"+id);_this2.$.beaker.write("pages/"+id+"/index.html","<p>My great new content!</p>");_this2.manifest.items[index]=element}});this.$.beaker.write("site.json",JSON.stringify(this.manifest,null,2));window.cmsSiteEditor.instance.haxCmsSiteEditorElement.$.toast.show("Outline saved!");window.cmsSiteEditor.instance.haxCmsSiteEditorElement.fire("haxcms-trigger-update",!0);this.fire("json-outline-schema-changed",this.manifest);case 7:case"end":return _context2.stop();}}},_callee2,this)}));return function saveOutline(){return _saveOutline.apply(this,arguments)}}(),saveManifest:function(){var _saveManifest=babelHelpers.asyncToGenerator(regeneratorRuntime.mark(function _callee3(e){return regeneratorRuntime.wrap(function(_context3){while(1){switch(_context3.prev=_context3.next){case 0:this.manifest=e.detail;_context3.next=3;return this.$.beaker.write("site.json",JSON.stringify(this.manifest,null,2));case 3:window.cmsSiteEditor.instance.haxCmsSiteEditorElement.$.toast.show("Site details saved!");window.cmsSiteEditor.instance.haxCmsSiteEditorElement.fire("haxcms-trigger-update",!0);this.fire("json-outline-schema-changed",this.manifest);case 6:case"end":return _context3.stop();}}},_callee3,this)}));return function saveManifest(){return _saveManifest.apply(this,arguments)}}(),_jwtTokenFired:function _jwtTokenFired(e){this.jwt=e.detail},generateResourceID:function generateResourceID(){var base=0<arguments.length&&arguments[0]!==void 0?arguments[0]:"";function idPart(){return _Mathfloor(65536*(1+Math.random())).toString(16).substring(1)}return base+idPart()+idPart()+"-"+idPart()+"-"+idPart()+"-"+idPart()+"-"+idPart()+idPart()+idPart()},attached:function(){var _attached=babelHelpers.asyncToGenerator(regeneratorRuntime.mark(function _callee4(){var _this3=this,beaker,info,appstore;return regeneratorRuntime.wrap(function(_context4){while(1){switch(_context4.prev=_context4.next){case 0:beaker=this.$.beaker;this.jwt=beaker.archive.url;_context4.next=4;return beaker.archive.getInfo();case 4:info=_context4.sent;if(!(null!=this.jwt&&info.isOwner)){_context4.next=12;break}_context4.t0=JSON;_context4.next=9;return beaker.read("appstore.json");case 9:_context4.t1=_context4.sent;appstore=_context4.t0.parse.call(_context4.t0,_context4.t1);try{new Promise(function(res,rej){return _require.default([(0,_resolveUrl.pathFromUrl)(meta.url)+"haxcms-site-editor.js"],res,rej)}).then(function(){var haxCmsSiteEditorElement=document.createElement("haxcms-site-editor");haxCmsSiteEditorElement.jwt=_this3.jwt;haxCmsSiteEditorElement.appStore=appstore;if(babelHelpers.typeof(_this3.__item)!=="undefined"){haxCmsSiteEditorElement.activeItem=_this3.__item}if(babelHelpers.typeof(_this3.__manifest)!=="undefined"){haxCmsSiteEditorElement.manifest=_this3.__manifest}if(babelHelpers.typeof(_this3.__body)!=="undefined"){haxCmsSiteEditorElement.__body=_this3.__body}window.cmsSiteEditor.instance.haxCmsSiteEditorElement=haxCmsSiteEditorElement;window.cmsSiteEditor.instance.appendTarget.appendChild(haxCmsSiteEditorElement)},function(){})}catch(err){}case 12:case"end":return _context4.stop();}}},_callee4,this)}));return function attached(){return _attached.apply(this,arguments)}}()})});