import{html,Polymer}from"../../../@polymer/polymer/polymer-legacy.js";import*as async from"../../../@polymer/polymer/lib/utils/async.js";import{Router}from"../../../@vaadin/router/dist/vaadin-router.js";import{observable,decorate}from"../../../mobx/lib/mobx.module.js";export const store={manifest:null,location:null};decorate(store,{manifest:observable,location:observable.ref});Polymer({_template:html`
    <style>
      :host {
        display: block;
      }
    </style>
  `,is:"haxcms-site-router",properties:{manifest:{type:Object,notify:!0,observer:"_manifestChanged"},baseURI:{type:String}},created:function(){window.addEventListener("vaadin-router-location-changed",this._routerLocationChanged.bind(this));window.addEventListener("haxcms-router-manifest-changed",this._haxcmsRouterManifestChanged.bind(this));window.addEventListener("haxcms-router-manifest-subscribe",this._haxcmsRouterManifestSubscribe.bind(this));window.addEventListener("json-outline-schema-changed",this._jsonOutlineSchemaChangedHandler.bind(this));window.addEventListener("json-outline-schema-active-item-changed",this._jsonOutlineSchemaActiveItemChangedHandler.bind(this));window.addEventListener("haxcms-site-router-location-subscribe",this._haxcmsSiteRouterLocationSubscribe.bind(this))},attached:function(){},detached:function(){window.addEventListener("vaadin-router-location-changed",this._routerLocationChanged.bind(this));window.addEventListener("haxcms-router-manifest-changed",this._haxcmsRouterManifestChanged.bind(this));window.addEventListener("haxcms-router-manifest-subscribe",this._haxcmsRouterManifestSubscribe.bind(this))},_haxcmsRouterManifestSubscribe:function(e){const subscription=Object.assign({},{setup:!1},e.detail);if("undefined"===typeof subscription.callback){console.error("No callback provided on haxcms-router-manifest-subscribe.");return}if("undefined"===typeof subscription.scope){console.error("No scope provided on haxcms-router-manifest-subscribe.");return}subscription.scope.addEventListener("haxcms-router-manifest-updated",subscription.scope[subscription.callback]);if(subscription.setup){const routerManifest=this._createManifestRouterInstance(this.manifest),syntheticEvent=new CustomEvent("haxcms-router-manifest-changed",{detail:routerManifest});subscription.scope[subscription.callback](syntheticEvent)}},_manifestChanged:function(newValue){if(newValue){const routerManifest=this._createManifestRouterInstance(newValue);window.dispatchEvent(new CustomEvent("haxcms-router-manifest-changed",{detail:routerManifest}))}},_createManifestRouterInstance:function(manifest){if("undefined"!==typeof manifest&&"undefined"!==typeof manifest.items){const manifestItems=manifest.items.map(i=>{let location=i.location.replace("pages/","").replace("/index.html","");return Object.assign({},i,{location:location})});return Object.assign({},manifest,{items:manifestItems})}},_haxcmsRouterManifestChanged:function(e){this._updateRouter(e.detail)},_updateRouter:function(manifest){if(!manifest)return;let options={};if(this.baseURI){options.baseUrl=this.baseURI}const router=new Router(this,options),routerItems=manifest.items.map(i=>{return{path:i.location,name:i.id,component:"haxcms-site-router-location"}});router.setRoutes([...routerItems,{path:"/",component:"haxcms-site-router-location",name:"home"},{path:"/(.*)",component:"haxcms-site-router-location",name:"404"}])},_routerLocationChanged:function(e){this._location=e.detail.location;store.location=this._location;window.dispatchEvent(new CustomEvent("haxcms-site-router-location-changed",{detail:e.detail.location}));const activeItem=e.detail.location.route.name;let find=this.manifest.items.filter(item=>{if(item.id!==activeItem){return!1}return!0});if(0<find.length){let found=find.pop();async.microTask.run(()=>{setTimeout(()=>{if(typeof window.cmsSiteEditor!==typeof void 0){window.cmsSiteEditor.initialActiveItem=found}this.fire("haxcms-active-item-changed",found)},150)})}},_jsonOutlineSchemaChangedHandler:function(e){const manifest=e.detail;this.manifest={};this.manifest=manifest},_jsonOutlineSchemaActiveItemChangedHandler:function(e){window.dispatchEvent(new CustomEvent("haxcms-site-router-active-item-changed",{detail:e.detail}))},_haxcmsSiteRouterLocationSubscribe:function(e){const subscription=Object.assign({},{setup:!1},e.detail);if("undefined"===typeof subscription.callback){console.error("No callback provided on haxcms-site-router-location-subscribe.");return}if("undefined"===typeof subscription.scope){console.error("No scope provided on haxcms-site-router-location-subscribe.");return}subscription.scope.addEventListener("haxcms-site-router-location-changed",subscription.scope[subscription.callback]);if(subscription.setup){const syntheticEvent=new CustomEvent("haxcms-site-router-location-changed",{detail:this._location});subscription.scope[subscription.callback](syntheticEvent)}}});