import{observable as e,makeObservable as t,computed as a,autorun as i,toJS as s,configure as n}from"../../../../mobx/dist/mobx.esm.js";import{varExists as o,varGet as r,localStorageGet as l}from"../../../utils/utils.js";import{JsonOutlineSchema as d}from"../../../json-outline-schema/json-outline-schema.js";import{DeviceDetails as c}from"../../../replace-tag/lib/PerformanceDetect.js";import{SimpleIconsetStore as m}from"../../../simple-icon/lib/simple-iconset.js";import{UserScaffoldInstance as h}from"../../../user-scaffold/user-scaffold.js";n({enforceActions:!1});export function iconFromPageType(e){switch(e){case"content":return"lrn:page";case"assessment":return"lrn:assessment";case"quiz":return"lrn:quiz";case"submission":return"icons:move-to-inbox";case"lesson":return"hax:lesson";case"module":return"hax:module";case"unit":return"hax:unit";case"task":return"hax:task";case"activity":return"hax:ticket";case"project":return"hax:bulletin-board";case"practice":return"hax:shovel";case"connection":return"courseicons:chem-connection";case"knowledge":return"courseicons:knowledge";case"strategy":case"discuss":case"make":case"observe":case"present":case"read":case"reflect":case"research":case"watch":return"courseicons:strategy";case"listen":return"courseicons:listen";case"write":return"lrn:write"}return"courseicons:learning-objectives"}export const store=new class Store{constructor(){this.badDevice=!1,this.internalRoutes={search:{},views:{},tags:{},random:{},home:{},"theme/style-guide":{callback:()=>{},useHaxEditor:!0}},this.evaluatebadDevice(),this.location=null,this.currentRouterLocation={},this.jwt=null,this.version=null,this.soundStatus=l("app-hax-soundStatus",!0),this.darkMode=!!l("app-hax-darkMode")&&l("app-hax-darkMode"),this.setupSlots={"haxcms-site-editor-ui-prefix-avatar":[],"haxcms-site-editor-ui-prefix-buttons":[],"haxcms-site-editor-ui-suffix-buttons":[],"haxcms-site-editor-ui-main-menu":[],"haxcms-site-editor-ui-topbar-character-button":[]},fetch(new URL("../../package.json",import.meta.url)).then((e=>e.json())).then((e=>this.version=e.version)),this.appReady=!1,this.editMode=!1,this.manifest=null,this.pageAllowed=!1,this.activeItemContent="",this.themeElement=null,this.themeStyleElement=globalThis.document.createElement("style"),this.themeStyleElement.id="haxcms-theme-global-style-element",this.t={close:"Close",search:"Search",views:"Content views",tags:"Content tags",random:"Random page",home:"Home page","theme/style-guide":"Theme Style Guide",pageNotFound:"Page not found"},this.activeId=null,this.userData={},this.cmsSiteEditor={instance:null},this.cmsSiteEditorBackend={instance:null},this._registration={},t(this,{location:e.ref,currentRouterLocation:e.ref,internalRoutes:e,editMode:e,jwt:e,userData:e,manifest:e,activeItemContent:e,themeElement:e,version:e,routerManifest:a,siteTitle:a,siteDescription:a,isLoggedIn:a,themeData:a,regionData:a,entityData:a,homeLink:a,activeId:e,activeItem:a,activeItemFields:a,activeManifestIndex:a,activeManifestIndexCounter:a,activeTitle:a,activeTags:a,parentTitle:a,ancestorTitle:a,ancestorItem:a,pageCounter:a,darkMode:e,viewOnlyMode:a,soundStatus:e,appReady:e,badDevice:e,pageAllowed:e})}get entityData(){if(this.manifest&&this.manifest.items){var e={};return this.manifest.items.map((t=>{t.metadata&&(e[t.id]={id:t.id,title:t.title,color:t.metadata.color||null,icon:t.metadata.icon||null,type:t.metadata.entityType||"page"})})),e}}get regionData(){if(this.manifest){return o(this.manifest,"metadata.theme.regions")?this.manifest.metadata.theme.regions:{header:null,sidebarFirst:null,sidebarSecond:null,contentTop:null,contentBottom:null,footerPrimary:null,footerSecondary:null}}}getUniqueSlugName(e,t=null,a=!1){let i=e;if(null!=t&&null!=t.parent&&""!=t.parent&&a){let a=t,s=[e];for(;a=this.findItem(a.parent);){let e=a.slug.split("/");s.unshift(e.pop())}i=e=s.join("/")}let s=0,n=!1;for(;!n;)for(var o in n=!0,this.manifest.items){let a=this.manifest.items[o];if(i==a.slug){if(null!=t&&a.id==t.id)return i;s++,i=e+"-"+s,n=!1}}return i.toLowerCase().split(" ").join("-").replace(/[^0-9\-\/a-z]/gi,"")}async evaluatebadDevice(){this.badDevice=await c.badDevice(),this.badDevice&&(this.soundStatus=!1)}playSound(e){if(this.soundStatus&&this.appReady)try{switch(e){case"click":case"click2":case"coin":case"coin2":case"hit":case"success":case"error":"error"==e&&(e="hit"),this.audio=new Audio(new URL(`../../../app-hax/lib/assets/sounds/${e}.mp3`,import.meta.url).href),this.audio.volume=.3,this.audio.play();break;default:this.audio=new Audio(new URL("../../../app-hax/lib/assets/sounds/hit.mp3",import.meta.url).href),this.audio.volume=.3,this.audio.play(),console.warn(`${e} is not a valid sound file yet`)}}catch(e){console.warn(e)}}toast(e,t=2e3,a={},i="capsule",s=this.t.close,n=null,o=null){this.appReady&&globalThis.dispatchEvent(new CustomEvent("haxcms-toast-show",{bubbles:!0,composed:!0,cancelable:!0,detail:{text:e,duration:t,classStyle:i,closeText:s,eventCallback:n,slot:o,...a}}))}async loadManifest(e,t=null){if(null==t&&window&&(t=window),o(e,"metadata.siteName")){let t=r(e,"publishing.git",{});e.metadata.site={name:e.metadata.siteName,git:t,created:e.metadata.created,updated:e.metadata.updated},e.metadata.theme.variables={image:e.metadata.image,icon:e.metadata.icon,hexCode:e.metadata.hexCode,cssVariable:e.metadata.cssVariable},e.metadata.node={dynamicElementLoader:e.metadata.dynamicElementLoader,fields:e.metadata.fields},delete e.metadata.publishing,delete e.metadata.created,delete e.metadata.updated,delete e.metadata.siteName,delete e.metadata.image,delete e.metadata.icon,delete e.metadata.hexCode,delete e.metadata.cssVariable,delete e.metadata.dynamicElementLoader,delete e.metadata.fields}await e.items.forEach(((e,t,a)=>{e.slug||(a[t].slug=e.location.replace("pages/","").replace("/index.html","")),e.metadata.hasOwnProperty("published")||(a[t].metadata.published=!0),a[t].order=Number(a[t].order),e.metadata.hasOwnProperty("locked")||(a[t].metadata.locked=!1),e.metadata.hasOwnProperty("status")||(a[t].metadata.status="")}));var a=new d,i=a.itemsToNodes(e.items),s=a.nodesToItems(i),n=[];for(var l in s)n.push(e.items.find((e=>e.id===s[l].id)));globalThis.document.documentElement&&e.metadata.site.lang&&(globalThis.document.documentElement.lang=e.metadata.site.lang,globalThis.dispatchEvent(new CustomEvent("languagechange",{detail:e.metadata.site.lang}))),e.items=n,this.manifest=e,this.clearStyleGuideCache(),t.dispatchEvent(new CustomEvent("json-outline-schema-changed",{bubbles:!0,composed:!0,cancelable:!1,detail:e})),globalThis.dispatchEvent(new CustomEvent("haxcms-item-rebuild",{bubbles:!0,composed:!0,cancelable:!1,detail:!0}))}cmsSiteEditorAvailability(){return this.viewOnlyMode?null:(this.cmsSiteEditor.instance||(this.cmsSiteEditor.instance=globalThis.document.createElement("haxcms-site-editor")),this.cmsSiteEditor.instance)}get processedItems(){}getItemChildren(e){if(this.manifest&&this.manifest.items)return this.manifest.items.filter((t=>t.parent===e))}_computeItems(e,t,a,i,s){if(s){let n,o=[],r=[];switch(s.items.forEach((e=>{e.parent||o.push(e)})),i){case"parent":n=s.items.find((e=>a===e.id)),n&&(a=n.parent);break;case"ancestor":for(n=s.items.find((e=>a===e.id));n&&null!=n.parent;)n=s.items.find((e=>e.id==n.parent));n&&(a=n.id)}return o.forEach(((i,s)=>{this._spiderChildren(i,r,e,t,a,!1)})),r}}_setChildren(e,t){const a=t.filter((t=>e.id===t.parent));e.children=a,e.children.length>0&&e.children.forEach((e=>{this._setChildren(e,t)}))}get routerManifest(){const e=this.manifest;if(globalThis.document.body.dispatchEvent(new CustomEvent("json-outline-schema-changed",{bubbles:!0,composed:!0,cancelable:!1,detail:e})),e&&void 0!==e.items){let t=e.items.map((t=>{let a=null,i=null,s=e.items.find((e=>t.parent===e.id));s&&(a=s.location,i=s.slug);let n=t.metadata,o=t.location,r=t.slug;return n&&n.pageType&&!n.icon&&(t.metadata.icon=iconFromPageType(n.pageType)),Object.assign({},t,{parentLocation:a,parentSlug:i,location:o,slug:r,metadata:n})}));if(t.forEach(((e,a)=>{this._setChildren(e,t)})),!0===r(e,"metadata.site.settings.publishPagesOn",!0)){const filterHiddenParentsRecursive=e=>{if(!1===e.metadata.published)return!1;const a=t.find((t=>t.id===e.parent));return!a||filterHiddenParentsRecursive(a)};this.isLoggedIn||(t=t.filter((e=>filterHiddenParentsRecursive(e))))}return Object.assign({},e,{items:t})}}get siteTitle(){return this.manifest&&this.manifest.title?this.manifest.title:""}get siteDescription(){return this.manifest&&this.manifest.description?this.manifest.description:""}get homeLink(){if(this.manifest){const e=this.manifest.items.find((e=>void 0!==e.id));if(e)return e.slug}return"/"}get activeItem(){let e=this.findItem(this.activeId);if(this.activeId&&HAXcmsStore.storePieces&&HAXcmsStore.storePieces.siteRouter&&null==e&&"404"===this.activeId){e={id:"404",_internalRoute:!0,title:this.t.pageNotFound,location:"hax-fake-404.html"};const t=store.getInternalRoute();t&&store.internalRoutes[t]&&("function"==typeof store.internalRoutes[t].callback&&store.internalRoutes[t].callback(),e={id:"x/"+t,_internalRoute:!0,component:`site-${t.replace("/","-")}-route`,title:this.t[t]||t,location:"hax-internal-route.html"})}return e||null}get activeItemFields(){if(this.activeItem&&this.activeItem.metadata){let e={title:this.activeItem.title,description:this.activeItem.description,location:this.activeItem.location,slug:this.activeItem.slug,created:this.activeItem.metadata.created,updated:this.activeItem.metadata.created};if(this.activeItem.metadata.fields)return Object.assign({},e,this.activeItem.metadata.fields)}}get themeData(){if(this.manifest){var e={};return e=o(this.manifest,"metadata.theme")?this.manifest.metadata.theme:{"haxcms-basic-theme":{element:"haxcms-basic-theme",path:"@haxtheweb/haxcms-elements/lib/core/themes/haxcms-basic-theme.js",name:"Basic theme",variables:{icon:"icons:record-voice-over",hexCode:"#da004e",cssVariable:"pink",image:"assets/banner.jpg",imageAlt:"",imageLink:""},regions:{header:null,sidebarFirst:null,sidebarSecond:null,contentTop:null,contentBottom:null,footerPrimary:null,footerSecondary:null}}},this.activeItem&&o(this.activeItem,"metadata.theme")?this.activeItem.metadata.theme:e}}get activeManifestIndex(){if(this.manifest&&this.manifest.items&&this.activeId)for(var e in this.manifest.items)if(this.manifest.items[e].id===this.activeId)return parseInt(e);return-1}get activeRouterManifestIndex(){if(this.routerManifest&&this.routerManifest.items&&this.activeId)for(var e in this.routerManifest.items)if(this.routerManifest.items[e].id===this.activeId)return parseInt(e);return-1}get activeManifestIndexCounter(){return null!==this.activeManifestIndex?1+this.activeManifestIndex:0}get activeTitle(){return this.activeItem?this.activeItem.title:""}get activeTags(){return this.activeItem&&this.activeItem.metadata&&this.activeItem.metadata.tags?this.activeItem.metadata.tags:null}get parentTitle(){if(this.manifest&&this.activeItem){let e=this.manifest.items.find((e=>this.activeItem.parent===e.id));if(e)return e.title}return""}get pageCounter(){return{current:this.activeManifestIndexCounter,total:this.manifest.items.length}}get siblingsPrevNext(){if(this.manifest.items&&this.activeItem){const e=this.manifest.items.filter((e=>e.parent===this.activeItem.parent)),t=e.findIndex((e=>e.id===this.activeItem.id));return{prev:e[t-1]||null,next:e[t+1]||null}}return{prev:null,next:null}}showViewOnlyModeToast(){const e=globalThis.document.createElement("button");e.innerText="Exit View Only Mode",e.style.cssText="\n      background-color: var(--simple-colors-default-theme-blue-7);\n      color: white;\n      border: none;\n      cursor: pointer;\n      border-radius: 0;\n    ",e.addEventListener("click",(()=>{h.deleteMemory("ViewOnlyMode","long"),setTimeout((()=>{globalThis.location.reload()}),300)})),store.toast("You are now viewing the site as a visitor would see it. All editing tools are hidden.",0,{hat:"coffee",slot:e})}get viewOnlyMode(){return h.readMemory("ViewOnlyMode")}get isLoggedIn(){return!this.viewOnlyMode&&!(!this.jwt||"null"==this.jwt)}get ancestorTitle(){if(this.manifest&&this.activeItem){let e=this.manifest.items.find((e=>this.activeItem.parent===e.id));for(;e&&null!=e.parent;)e=this.manifest.items.find((t=>t.id==e.parent));if(e)return e.title}return""}get ancestorItem(){if(this.manifest&&this.activeItem){let e=this.manifest.items.find((e=>this.activeItem.parent===e.id));for(;e&&null!=e.parent;)e=this.manifest.items.find((t=>t.id==e.parent));if(e)return e}return null}findItem(e){return this.manifest&&e?this.manifest.items.find((t=>t.id===e)):null}async getLastChildItem(e){if(this.manifest){let t={};return await this.manifest.items.map((a=>{a.parent===e&&(void 0===t.order||t.order<a.order)&&(t=a)})),t}return null}async findItemAsObject(e,t="id",a="item",i=!0){if(this.manifest&&e){var n=await this.manifest.items.find((a=>a[t]===e));if(i&&(n=s(n)),"item"==a)return n;if("parent"==a&&n.parent)return s(await this.manifest.items.find((e=>n.parent===e.id)))}return null}fallbackItemSlug(){if(this.manifest&&this.activeItem){if(this.activeManifestIndex>0&&this.manifest.items[this.activeManifestIndex-1])return this.manifest.items[this.activeManifestIndex-1].slug;if(this.activeManifestIndex<this.manifest.items.length-1&&this.manifest.items[this.activeManifestIndex+1])return this.manifest.items[this.activeManifestIndex+1].slug}return null}getManifestItems(e=!0){return e?s(this.manifest.items):this.manifest.items}getManifest(e=!0){return e?s(this.manifest):this.manifest}async addItem(e){var t=new d;let a=t.newItem();e.id&&(a.id=e.id),e.indent&&(a.indent=e.indent),a.location=e.location,a.slug=e.slug,a.order=e.order,a.parent=e.parent,a.title=e.title,a.metadata=e.metadata,t.items=s(this.manifest.items);let i={...t.validateItem(a)};t.items.push(i);var n=t.itemsToNodes(t.items),o=t.nodesToItems(n),r=[];for(var l in o)r.push(t.items.find((e=>e.id===o[l].id)));return this.manifest.items.replace(r),globalThis.dispatchEvent(new CustomEvent("json-outline-schema-changed",{bubbles:!0,composed:!0,cancelable:!1,detail:this.manifest})),globalThis.dispatchEvent(new CustomEvent("haxcms-item-rebuild",{bubbles:!0,composed:!0,cancelable:!1,detail:!0})),this.findItem(a.id)}removeItem(e){const t=this.findItem(e);if(t)if("new"===t.metadata.status){const e=this.manifest.items.indexOf(t);e>-1&&this.manifest.items.splice(e,1)}else t.metadata.status="delete"}async loadItemContent(e){const t=this.findItem(e);if(!t||!t.location)return"";try{let e="";HAXcmsStore.storePieces&&HAXcmsStore.storePieces.siteBuilder&&(e=HAXcmsStore.storePieces.siteBuilder.outlineLocation||"");const a=`${e}${t.location}`,i=await fetch(a);if(i.ok)return await i.text()}catch(t){console.warn("Failed to load content for item:",e,t)}return""}async loadStyleGuideContent(){const e=`${this.manifest&&this.manifest.id?this.manifest.id:"default"}-${this.manifest&&this.manifest.metadata&&this.manifest.metadata.theme&&this.manifest.metadata.theme.styleGuide?this.manifest.metadata.theme.styleGuide:"default"}`;if(this._styleGuideCache||(this._styleGuideCache=new Map),this._styleGuideCache.has(e))return this._styleGuideCache.get(e);try{let t="";HAXcmsStore.storePieces&&HAXcmsStore.storePieces.siteBuilder&&(t=HAXcmsStore.storePieces.siteBuilder.outlineLocation||"");let a="theme/style-guide.html";this.manifest&&this.manifest.metadata&&this.manifest.metadata.theme&&this.manifest.metadata.theme.styleGuide?(a=this.manifest.metadata.theme.styleGuide,a.startsWith("http://")||a.startsWith("https://")||(a=`${t}${a}`)):a=`${t}${a}`;const i=await fetch(a);let s;if(i.ok){const e=i.headers.get("content-type");if(e&&(e.includes("text/html")||e.includes("text/plain"))){const e=await i.text();if(!e||!this.isValidStyleGuideContent(e))return console.warn("Style guide URL returned HTML without valid page-template tags - likely htaccess redirect to index. Treating as missing style guide."),s=this.getDefaultStyleGuideContent(),s;s=e}else console.warn(`Style guide URL returned non-HTML content type: ${e}`),s=this.getDefaultStyleGuideContent()}else{if(404!==i.status)throw new Error(`HTTP ${i.status}: ${i.statusText}`);s=this.getDefaultStyleGuideContent()}return this._styleGuideCache.set(e,s),s}catch(t){console.warn("Failed to load style guide content:",t);const a=this.getDefaultStyleGuideContent();return this._styleGuideCache.set(e,a),a}}clearStyleGuideCache(){this._styleGuideCache&&this._styleGuideCache.clear()}isValidStyleGuideContent(e){if(!e||"string"!=typeof e)return!1;const t=/<page-template[\s\S]*?>/i.test(e),a=[/<haxcms-site-builder/i,/<site-menu/i,/<json-outline-schema/i,/manifest\.json/i,/site\.json/i].some((t=>t.test(e)));return t&&!a}getDefaultStyleGuideContent(){return'<page-template name="Default H1" schema="block" enforce-styles="enforce-styles" data-haxsg-id="header-1a2b03c4-5d6e-7f8g-9h0i-jk1l2m3n4o5p">\n  <h1  data-primary="21" data-font-size="xl" data-font-family="navigation" data-font-weight="bold" data-padding="s" data-margin="l" data-text-align="center" data-design-treatment="horz-full">Heading 1 Example</h1>\n</page-template>\n\n<page-template name="Default H2" schema="block" enforce-styles="enforce-styles" data-haxsg-id="header-8a1e05f0-1ab1-8c5e-f81f-ef2cafc290fa">\n  <h2 data-primary="11" data-font-size="l" data-font-family="navigation" data-font-weight="light" data-padding="s" data-margin="m" data-text-align="center" data-design-treatment="horz-full">Heading 2</h2>\n</page-template>\n\n<page-template name="Default H3" schema="block" enforce-styles="enforce-styles" data-haxsg-id="header-3b4c05d6-7e8f-9g0h-1i2j-kl3m4n5o6p7q">\n  <h3 data-primary="21" data-font-size="m" data-font-family="navigation" data-font-weight="normal" data-padding="xs" data-margin="s" data-text-align="left" data-design-treatment="bg">Heading 3 Example</h3>\n</page-template>\n\n<page-template name="Default H4" schema="block" enforce-styles="enforce-styles" data-haxsg-id="header-dsfdfs-7e8f-9g0h-1i2j-kl3m4n5o6p7q">\n  <h4 data-primary="21" data-font-size="m" data-font-family="navigation" data-font-weight="normal" data-padding="xs" data-margin="s" data-text-align="left" data-design-treatment="bg">Heading 4 Example</h4>\n</page-template>\n\n<page-template name="Default List" schema="block" enforce-styles="enforce-styles" data-haxsg-id="list-4c5d06e7-8f9g-0h1i-2j3k-lm4n5o6p7q8r">\n  <ul data-padding="s" data-margin="m" data-primary="14">\n    <li>First item</li>\n    <li>Second item</li>\n    <li>Third item</li>\n  </ul>\n</page-template>\n<page-template name="Default Ordered List" schema="block" enforce-styles="enforce-styles" data-haxsg-id="orderedlist-5d6e07f8-9g0h-1i2j-3k4l-mn5o6p7q8r9s">\n  <ol data-margin="m">\n    <li>First step</li>\n    <li>Second step</li>\n    <li>Third step</li>\n  </ol>\n</page-template>\n<page-template name="bill p" schema="page" enforce-styles="" data-haxsg-id="p-fgdfgdgdgd-9g0h-1i2j-3k4l-mn5o6p7q8r9s">\n  <p data-accent="3" data-primary="5" data-font-weight="medium" data-font-family="navigation" data-font-size="l" data-border-radius="md" data-border="lg">THIS IS A P TAG !!!</p>\n  <p data-accent="3" data-primary="5" data-font-weight="medium" data-font-family="navigation" data-font-size="l" data-border-radius="md" data-border="lg">THIS IS A P TAG !!!</p>\n</page-template>\n<page-template name="Default Video" schema="area" data-haxsg-id="video-6e7f08g9-0h1i-2j3k-4l5m-no6p7q8r9s0t">\n  <video-player data-width="50" source="https://www.youtube.com/watch?v=dQw4w9WgXcQ" caption="Example video player" accent-color="blue" data-padding="m" data-margin="l"></video-player>\n</page-template>\n<page-template name="Class video" schema="page" data-haxsg-id="quote-7f8g09h0-1i2j-3k4l-5m6n-op7q8r9s0t1u">\n<grid-plate item-margin="16" item-padding="16" layout="1-1" disable-responsive="">\n  <h3 id="header-a11e7d5c-b0ec-0b3a-eda2-30bca4e4c2b0" slot="col-1">Colun 1</h3>\n  <p slot="col-1">This is a video template!</p>\n  <h3 id="header-91905f70-f8a0-5df3-716d-8dcf1f9ab26c" slot="col-2">Video maaaan</h3>\n  <video-player source="https://www.youtube.com/watch?v=LrS7dqokTLE" data-width="75" data-margin="center" slot="col-2" accent-color="grey" crossorigin="anonymous" sticky-corner="none" resource="#3ef518fe-5254-a689-ab9c-580675b16d99" prefix="oer:http://oerschema.org/ schema:http://schema.org/ dc:http://purl.org/dc/terms/ foaf:http://xmlns.com/foaf/0.1/ cc:http://creativecommons.org/ns# bib:http://bib.schema.org " element-visible="" lang="en" source-type="youtube" sources="[]" source-data="[{&quot;src&quot;:&quot;https://www.youtube.com/embed/LrS7dqokTLE&quot;,&quot;type&quot;:&quot;&quot;}]" tracks="[]"></video-player>\n</grid-plate>\n</page-template>'}spiderChildren(e,t,a,i,s,n,o){e.id===s||n?(n||(n=!0,!o&&e.indent>=a&&(a+=e.indent,i+=e.indent)),e.indent>=a&&e.indent<=i&&t.push(e),e.children.length>0&&e.children.forEach((e=>{this.spiderChildren(e,t,a,i,s,n,o)}))):e.children.length>0&&e.children.forEach((e=>{this.spiderChildren(e,t,i,s,n,o)}))}getInternalRoute(){return!!(this.currentRouterLocation&&this.currentRouterLocation.params&&this.currentRouterLocation.params[0])&&this.currentRouterLocation.params[0].replace("x/","")}currentRouteSupportsHaxEditor(){if(this.activeItem&&this.activeItem.id&&!this.activeItem._internalRoute)return!0;const e=this.getInternalRoute();return!(!e||!this.internalRoutes[e])&&!0===this.internalRoutes[e].useHaxEditor}computeItems(e,t,a,i,s,n){if(s){let o,r=[],l=[];switch(s.items.forEach((e=>{e.parent||r.push(e)})),i){case"parent":o=s.items.find((e=>a===e.id)),o&&(a=o.parent);break;case"ancestor":for(o=s.items.find((e=>a===e.id));o&&null!=o.parent;)o=s.items.find((e=>e.id==o.parent));o&&(a=o.id)}return s.items.forEach(((i,s)=>{store.spiderChildren(i,l,e,t,a,!1,n)})),l}}};globalThis.HAXCMS=globalThis.HAXCMS||{},globalThis.HAXCMS.setTheme=function(e){globalThis.HAXCMS.instance.store.manifest.metadata.theme.element=e},globalThis.HAXCMS.requestAvailability=()=>(globalThis.HAXCMS.instance||(globalThis.HAXCMS.instance=globalThis.document.createElement("haxcms-site-store"),globalThis.document.body.appendChild(globalThis.HAXCMS.instance)),globalThis.HAXCMS.instance);export const HAXcmsStore=globalThis.HAXCMS.requestAvailability();class HAXCMSSiteStore extends HTMLElement{constructor(){super(),this.storePieces={},this.store=store,this.source="",globalThis.addEventListener("playaudio",this.playSoundEvent.bind(this)),i((()=>{if(store.location&&store.location.route&&store.location.route.component){const e=store.location.route.name;if(store.manifest.items.find((t=>t.id===e)))store.activeId=e;else if(store.getInternalRoute())store.activeId="404";else{let e=null;if("home"===store.location.route.name){const t=store.manifest;t&&t.metadata&&t.metadata.site&&t.metadata.site.homePageId&&""!==t.metadata.site.homePageId&&(e=store.manifest.items.find((e=>e.id===t.metadata.site.homePageId)),e&&!e._internalRoute?e.metadata&&!1===e.metadata.published&&!store.isLoggedIn&&(console.warn("Configured home page is not published, falling back to first page"),e=null):(console.warn("Configured home page ID does not exist in manifest, falling back to first page"),e=null))}e||(e=store.manifest.items.find((e=>void 0!==e.id))),e&&(store.activeId=e.id)}}})),i((()=>{const e=s(store.findItem(store.activeId));e&&(globalThis.document.body.dispatchEvent(new CustomEvent("json-outline-schema-active-item-changed",{bubbles:!0,composed:!0,cancelable:!1,detail:e})),globalThis.document.title=store.activeTitle)})),i((()=>{if(store.appReady){const e=globalThis.document.querySelector('link[rel="icon"]');e&&(this.faviconSiteDefault=e.href,this.faviconInstance=e)}})),i((()=>{setTimeout((()=>{store.viewOnlyMode&&store.showViewOnlyModeToast()}),1e3)})),i((()=>{const e=h.readMemory("versionLatest");store.version&&e!=store.version&&(null==e&&h.writeMemory("versionInitial",store.version,"long"),h.writeMemory("versionLatest",store.version,"long"))})),i((()=>{const e=s(store.editMode);globalThis.HaxStore&&globalThis.HaxStore.requestAvailability()&&globalThis.HaxStore.requestAvailability().write&&(globalThis.dispatchEvent(new CustomEvent("haxcms-edit-mode-changed",{bubbles:!0,composed:!0,cancelable:!1,detail:e})),globalThis.HaxStore.requestAvailability().editMode=e,globalThis.HaxStore.requestAvailability().toastShowEventName="haxcms-toast-show")}))}playSoundEvent(e){this.store.playSound(e.detail.sound)}connectedCallback(){globalThis.document.body.appendChild(this.store.themeStyleElement)}disconnectedCallback(){this.store.themeStyleElement.remove(),this.store.themeStyleElement=globalThis.document.createElement("style")}resetFavicon(){this.setFavicon()}setFavicon(e=null,t=!0){e?t&&(e=m.getIcon(e)):e=this.faviconSiteDefault,this.faviconInstance&&this.faviconInstance.setAttribute("href",e)}resetCursor(){this.setCursor()}setCursor(e=null,t=!0){e?(t&&(e=m.getIcon(e)),globalThis.document.body.style.cursor=`url("${e}") 16 16, pointer`):globalThis.document.body.style.removeProperty("cursor")}getApplicationContext(){let e="";if("undefined"!=typeof DatArchive)e="beaker";else switch(globalThis.HAXCMSContext){case"published":case"nodejs":case"php":case"11ty":case"demo":case"desktop":case"local":case"userfs":e=globalThis.HAXCMSContext;break;default:e="php"}return e}static get tag(){return"haxcms-site-store"}static get observedAttributes(){return["source"]}set source(e){this[name]=e,e&&this.setAttribute("source",e)}get source(){return this.getAttribute("source")}attributeChangedCallback(e,t,a){"source"==e&&""!=a&&fetch(this[e]).then((e=>e.json())).then((e=>{this.store.loadManifest(e)})).catch((e=>{console.warn(e)}))}}globalThis.customElements.define(HAXCMSSiteStore.tag,HAXCMSSiteStore);export{HAXCMSSiteStore};