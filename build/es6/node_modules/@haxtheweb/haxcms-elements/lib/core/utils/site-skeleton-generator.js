import{store as e}from"../haxcms-site-store.js";import{toJS as t}from"../../../../../mobx/dist/mobx.esm.js";import{generateResourceID as a}from"../../../../utils/utils.js";export class SiteSkeletonGenerator{static async generateFromCurrentSite(a=!1){const i=t(e.manifest);if(!i||!i.items)throw new Error("No site data available to generate skeleton");if(i.items.length>20&&!a){if(!confirm(`This site has ${i.items.length} pages. Generating a skeleton may take a while and create a large file. Continue?`))throw new Error("Skeleton generation cancelled by user")}const s=this.extractThemeConfiguration(i),n=await this.extractSiteStructure(i.items),r=await this.extractSiteFiles();return{meta:{name:this.getSiteMetaName(i),description:this.getSiteDescription(i),version:"1.0.0",created:(new Date).toISOString(),type:"skeleton",sourceUrl:globalThis.location.href,useCaseTitle:this.getSiteMetaName(i),useCaseDescription:this.getSiteDescription(i),useCaseImage:`@haxtheweb/haxcms-elements/lib/theme-screenshots/theme-${s.element}-thumb.jpg`,category:this.extractSiteCategories(i)||[],tags:this.extractSiteTags(i)||[],attributes:[]},site:{name:this.getSiteMetaName(i),description:this.getSiteDescription(i),theme:s.element||"clean-one"},build:{type:"skeleton",structure:"from-skeleton",items:n,files:r.map((e=>({path:e})))},theme:{...s.variables||{},...s.settings||{}},_skeleton:{originalMetadata:this.extractSiteMetadata(i),originalSettings:this.extractSiteSettings(i),fullThemeConfig:s}}}static getSiteMetaName(e){return e.metadata&&e.metadata.site&&e.metadata.site.name?e.metadata.site.name:"Untitled Skeleton"}static getSiteDescription(e){return e.description?`Template based on ${e.description}`:e.title?`Template based on ${e.title}`:"Template based on HAX Site"}static extractSiteMetadata(e){const t=e.metadata||{},a=t.site||{};return{site:{category:a.category||[],tags:a.tags||[],settings:this.cleanSiteSettings(a.settings||{})},licensing:t.licensing||{},node:t.node||{},platform:t.platform||{}}}static cleanSiteSettings(e){const t={...e};return delete t.created,delete t.updated,t}static extractThemeConfiguration(e){const t=(e.metadata||{}).theme||{};return{element:t.element||"clean-one",variables:t.variables||{},settings:{hexCode:t.hexCode,cssVariable:t.cssVariable,icon:t.icon,image:t.image,...this.extractCustomThemeProperties(t)}}}static extractCustomThemeProperties(e){const t={},a=["element","variables","hexCode","cssVariable","icon","image"];return Object.keys(e).forEach((i=>{a.includes(i)||(t[i]=e[i])})),t}static async extractSiteStructure(t){const i=new Map;t.forEach((e=>{i.set(e.id,a(""))}));const s=[];for(let a=0;a<t.length;a++){const n=t[a];let r="";try{r=await e.loadItemContent(n.id)}catch(e){console.warn(`Could not fetch content for page ${n.id}:`,e),r=""}s.push({id:i.get(n.id),title:n.title,slug:n.slug,order:n.order||a,parent:n.parent?i.get(n.parent):null,indent:n.indent||0,content:r,metadata:{published:this.getMetadataValue(n,"published",!0),hideInMenu:this.getMetadataValue(n,"hideInMenu",!1),tags:this.getMetadataValue(n,"tags",[]),...this.extractRelevantMetadata(n.metadata||{})}})}return s}static async extractSiteFiles(){const a=new Set,i=t(e.manifest);for(const t of i.items)try{const i=await e.loadItemContent(t.id);if(i){this.extractFileReferences(i,"files/").forEach((e=>a.add(e.path)))}}catch(e){console.warn(`Could not process files for page ${t.id}:`,e)}return Array.from(a)}static extractFileReferences(e,t){const a=[],i=/\w+="files\/([^"'\s>]+\.[a-zA-Z0-9]+)"/gi;let s;for(;null!==(s=i.exec(e));){const e=s[1];a.push({path:e})}return a}static getMetadataValue(e,t,a){return e.metadata&&void 0!==e.metadata[t]?e.metadata[t]:a}static extractRelevantMetadata(e){const t={};return["wordCount","difficulty","audience","contentType"].forEach((a=>{void 0!==e[a]&&(t[a]=e[a])})),t}static extractSiteCategories(e){return((e.metadata||{}).site||{}).category||[]}static extractSiteTags(e){return((e.metadata||{}).site||{}).tags||[]}static extractSiteSettings(e){const t=((e.metadata||{}).site||{}).settings||{},a={};return Object.keys(t).forEach((e=>{const i=t[e];null==i||""===i||Array.isArray(i)&&0===i.length||"object"==typeof i&&0===Object.keys(i).length||(a[e]=i)})),a}static generateDownloadableFile(e){const t=JSON.stringify(e,null,2);return new Blob([t],{type:"application/json"})}static downloadSkeleton(e,t){const a=`${e.meta.name.replace(/[^a-z0-9]/gi,"-").toLowerCase()}-skeleton.json`,i=this.generateDownloadableFile(e),s=URL.createObjectURL(i),n=document.createElement("a");n.href=s,n.download=t||a,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(s)}static toAppHaxFormat(e,t={}){return{site:{name:t.siteName||e.site.name,description:t.siteDescription||e.site.description,theme:t.theme||e.site.theme},build:{...e.build,items:e.build.items.map((e=>({...e,metadata:{...e.metadata,created:(new Date).toISOString(),updated:(new Date).toISOString()}})))},theme:{...e.theme,...t.color?{color:t.color}:{},...t.icon?{icon:t.icon}:{},...t.themeSettings}}}static generateFilesFromSkeleton(e,t={}){const a={};return e.structure.forEach((e=>{const t=`pages/${e.slug}/index.html`;a[t]=e.content||""})),e.files&&e.files.length>0&&e.files.forEach((e=>{a[`files/${e}`]=`[SKELETON_FILE_REFERENCE:${e}]`})),a}static rewriteSkeletonUuids(e){const t=new Map;e.structure.forEach((e=>{e.id&&t.set(e.id,a(""))}));const i=e.structure.map((e=>{const a={...e};return e.id&&(a.id=t.get(e.id)),e.parent&&t.has(e.parent)&&(a.parent=t.get(e.parent)),a})),s={...e.theme};if(s.settings&&s.settings.regions){const e={...s.settings.regions};Object.keys(e).forEach((a=>{const i=e[a];i&&"object"==typeof i&&Object.keys(i).forEach((e=>{const a=i[e];"string"==typeof a&&t.has(a)?i[e]=t.get(a):Array.isArray(a)&&(i[e]=a.map((e=>"string"==typeof e&&t.has(e)?t.get(e):e)))}))})),s.settings.regions=e}return{...e,structure:i,theme:s,meta:{...e.meta,created:(new Date).toISOString(),sourceUuids:"rewritten"}}}}export default SiteSkeletonGenerator;