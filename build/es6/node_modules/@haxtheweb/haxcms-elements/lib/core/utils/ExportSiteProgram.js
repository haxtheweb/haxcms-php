import{MicroFrontendRegistry as t}from"../../../../micro-frontend-registry/micro-frontend-registry.js";import{HAXStore as o}from"../../../../hax-body/lib/hax-store.js";import{store as e}from"../haxcms-site-store.js";import{toJS as a}from"../../../../../mobx/dist/mobx.esm.js";import{b64toBlob as i}from"../../../../utils/utils.js";export function createExportSiteProgram(t){return async(o,e)=>{let a=[];return[{title:"Export site as HTML",icon:"hax:file-html",format:"html",description:"Download entire site as consolidated HTML"},{title:"Export site as Markdown",icon:"hax:format-textblock",format:"markdown",description:"Download entire site as Markdown files"},{title:"Export site as DOCX",icon:"hax:file-docx",format:"docx",description:"Download entire site as Word document"},{title:"Export site as PDF",icon:"lrn:pdf",format:"pdf",description:"Download entire site as PDF"},{title:"Export site as EPUB",icon:"hax:file-ebook",format:"epub",description:"Download site as EPUB book"},{title:"Download site archive",icon:"icons:archive",format:"zip",description:"Download complete site as ZIP file"}].forEach((e=>{(""===o||e.title.toLowerCase().includes(o.toLowerCase())||e.format.includes(o.toLowerCase()))&&a.push({title:e.title,icon:e.icon,tags:["export","site",e.format],more:e.description,value:{target:t,method:"exportSiteAs",args:[e.format]},eventName:"super-daemon-element-method",path:`CMS/export/site/${e.format}`,context:["CMS"]})})),a}}export async function exportSiteAs(t){try{const i=a(e.manifest);if(!i||!i.metadata)return void o.toast("Site manifest not available for export",3e3,"fit-bottom");const s=i.title||"site",r=globalThis.document.querySelector("base")?.href||globalThis.location.origin;switch(t){case"html":await this._exportSiteAsHTML(i,s,r);break;case"markdown":await this._exportSiteAsMarkdown(i,s,r);break;case"docx":await this._exportSiteAsDOCX(i,s,r);break;case"pdf":await this._exportSiteAsPDF(i,s,r);break;case"epub":await this._exportSiteAsEPUB(i,s,r);break;case"zip":await this._downloadSiteArchive();break;default:o.toast(`Export format "${t}" not supported`,3e3,"fit-bottom")}}catch(t){console.error("Site export error:",t),o.toast(`Site export failed: ${t.message}`,3e3,"fit-bottom")}}export async function _exportSiteAsHTML(e,a,i){try{const s=await t.call("@haxcms/siteToHtml",{type:"site",site:{file:i+"/site.json",id:e.id,title:e.title,author:e.author,description:e.description,license:e.license,metadata:e.metadata,items:e.items},ancestor:null,link:i,magic:globalThis.__appCDN||"https://cdn.hax.cloud/cdn/",base:i,format:"json"});if(200!==s.status||!s.data)throw new Error("Failed to export site as HTML");this._downloadFile(s.data,`${a}.html`,"text/html"),o.toast("Site HTML downloaded successfully",3e3,"fit-bottom")}catch(t){console.error("Site HTML export error:",t),o.toast("Site HTML export service not available",3e3,"fit-bottom")}}export async function _exportSiteAsMarkdown(e,a,i){try{const s=await t.call("@haxcms/siteToHtml",{type:"site",site:{file:i+"/site.json",id:e.id,title:e.title,author:e.author,description:e.description,license:e.license,metadata:e.metadata,items:e.items},ancestor:null,link:i,magic:globalThis.__appCDN||"https://cdn.hax.cloud/cdn/",base:i,format:"json"});if(200!==s.status||!s.data)throw new Error("Failed to get site HTML for Markdown conversion");{const e=await t.call("@core/htmlToMd",{html:s.data});if(200!==e.status||!e.data)throw new Error("Failed to convert site HTML to Markdown");this._downloadFile(e.data,`${a}.md`,"text/markdown"),o.toast("Site Markdown downloaded successfully",3e3,"fit-bottom")}}catch(t){console.error("Site Markdown export error:",t),o.toast("Site Markdown export service not available",3e3,"fit-bottom")}}export async function _exportSiteAsDOCX(e,a,s){try{const r=await t.call("@haxcms/siteToHtml",{type:"site",site:{file:s+"/site.json",id:e.id,title:e.title,author:e.author,description:e.description,license:e.license,metadata:e.metadata,items:e.items},ancestor:null,link:s,magic:globalThis.__appCDN||"https://cdn.hax.cloud/cdn/",base:s,format:"json"});if(200!==r.status||!r.data)throw new Error("Failed to get site HTML for DOCX conversion");{const e=await t.call("@core/htmlToDocx",{html:r.data});if(200!==e.status||!e.data)throw new Error("Failed to convert site HTML to DOCX");{const t=i(e.data,"application/vnd.openxmlformats-officedocument.wordprocessingml.document");this._downloadBlob(t,`${a}.docx`),o.toast("Site DOCX downloaded successfully",3e3,"fit-bottom")}}}catch(t){console.error("Site DOCX export error:",t),o.toast("Site DOCX export service not available",3e3,"fit-bottom")}}export async function _exportSiteAsPDF(e,a,s){try{const r=await t.call("@haxcms/siteToHtml",{type:"site",site:{file:s+"/site.json",id:e.id,title:e.title,author:e.author,description:e.description,license:e.license,metadata:e.metadata,items:e.items},ancestor:null,link:s,magic:globalThis.__appCDN||"https://cdn.hax.cloud/cdn/",base:s,format:"json"});if(200!==r.status||!r.data)throw new Error("Failed to get site HTML for PDF conversion");{const e=await t.call("@core/htmlToPdf",{base:s,html:r.data});if(200!==e.status||!e.data)throw new Error("Failed to convert site HTML to PDF");{const t=i(e.data,"application/pdf");this._downloadBlob(t,`${a}.pdf`),o.toast("Site PDF downloaded successfully",3e3,"fit-bottom")}}}catch(t){console.error("Site PDF export error:",t),o.toast("Site PDF export service not available",3e3,"fit-bottom")}}export async function _exportSiteAsEPUB(e,a,i){try{const e=await t.call("@haxcms/siteToEpub",{type:"link",site:`${i}/site.json`,ancestor:null});if(200!==e.status||!e.data)throw new Error("Failed to export site as EPUB");{const t=new Blob([e.data],{type:"application/epub+zip"});this._downloadBlob(t,`${a}.epub`),o.toast("Site EPUB downloaded successfully",3e3,"fit-bottom")}}catch(t){console.error("Site EPUB export error:",t),o.toast("Site EPUB export service not available",3e3,"fit-bottom")}}export async function _downloadSiteArchive(){try{if(!globalThis.HAXCMS||!globalThis.HAXCMS.siteName)throw new Error("Site download not available");{const t=`${globalThis.location.origin}${globalThis.location.pathname}?download-site=true`,e=globalThis.document.createElement("a");e.href=t,e.download=`${globalThis.HAXCMS.siteName}.zip`,e.target="_blank",globalThis.document.body.appendChild(e),e.click(),globalThis.document.body.removeChild(e),o.toast("Site archive download initiated",3e3,"fit-bottom")}}catch(t){console.error("Site archive download error:",t),o.toast("Site archive download not available",3e3,"fit-bottom")}}export function _downloadFile(t,o,e="text/plain"){const a=new Blob([t],{type:e});this._downloadBlob(a,o)}export function _downloadBlob(t,o){const e=globalThis.document.createElement("a");e.href=globalThis.URL.createObjectURL(t),e.download=o,e.target="_blank",globalThis.document.body.appendChild(e),e.click(),globalThis.document.body.removeChild(e),globalThis.URL.revokeObjectURL(e.href)}