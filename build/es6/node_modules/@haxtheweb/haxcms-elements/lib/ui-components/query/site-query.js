/**
 * Copyright 2019 The Pennsylvania State University
 * @license Apache-2.0, see License.md for full text.
 */
import{LitElement as t}from"../../../../../lit/index.js";import{store as e}from"../../core/haxcms-site-store.js";import{objectValFromStringPos as r}from"../../../../utils/utils.js";import{autorun as i,toJS as s}from"../../../../../mobx/dist/mobx.esm.js";Object.byString=function(t,e){return r(t,e)};class SiteQuery extends t{static get tag(){return"site-query"}static get properties(){return{routerManifest:{type:Object},activeId:{type:String,attribute:"active-id"},result:{type:Array},conditions:{type:Object},sort:{type:Object},forceRebuild:{type:Boolean,attribute:"force-rebuild"},limit:{type:Number},startIndex:{type:Number,attribute:"start-index"},random:{type:Boolean},entity:{type:String}}}constructor(){super(),this.entity="node",this.conditions={},this.random=!1,this.sort={order:"ASC"},this.forceRebuild=!1,this.limit=0,this.startIndex=0}updated(t){t.forEach(((t,e)=>{if(["result","conditions","sort","forceRebuild"].includes(e)){let t=`${e.replace(/([a-z0-9]|(?=[A-Z]))([A-Z])/g,"$1-$2").toLowerCase()}-changed`;this.dispatchEvent(new CustomEvent(t,{detail:{value:this[e]}}))}["entity","conditions","sort","routerManifest","activeId","limit","startIndex","random","forceRebuild"].includes(e)&&(this.result=[...this._computeResult(this.entity,this.conditions,this.sort,this.routerManifest,this.activeId,this.limit,this.startIndex,this.random,this.forceRebuild)])}))}_computeResult(t,e,r,i,n,o,a,c,b){if(i&&i.items){var l=[...s(i.items)];for(var u in l)l[u].metadata=s(l[u].metadata);if("node"!==t){var d=[];for(var u in l)if(void 0!==Object.byString(l[u],t)){let e,r=Object.byString(l[u],t);if(e="object"==typeof r||"array"==typeof r?Object.assign([],Object.byString(l[u],t)):r,"object"==typeof e||"array"==typeof e)for(var u in e)if("object"==typeof e[u]||"array"==typeof e[u])e[u]._node=Object.assign({},l[u]),d.push(e[u]);else{let t={_node:Object.assign({},l[u]),value:e[u]};d.push(t)}else{let t={_node:Object.assign({},l[u]),value:e};d.push(t)}}l=Object.assign([],d)}if(e&&l)for(var u in e){null===e[u]?e[u]={value:[e[u]],operator:"="}:"object"!=typeof e[u]&&(e[u]={value:e[u],operator:"="});var y=e[u].value;"$activeId"===e[u].value?y=n:"$firstId"===e[u].value&&(y=l[0].id),l=l.filter((t=>{switch(e[u].operator){case"includes":try{const includesAll=(t,e)=>e.every((e=>t.includes(e)));if("object"==typeof Object.byString(t,u)){if(includesAll(Array.from(Object.byString(t,u)),y))return!0}else if(includesAll(Array.from(Object.byString(t,u).replaceAll(", ",",").split(",")),y))return!0}catch(t){console.warn(t)}return!1;case">":return Object.byString(t,u)>y;case"<":return Object.byString(t,u)<y;case"!=":return"object"==typeof y&&!y.includes(Object.byString(t,u))||("string"==typeof y&&Object.byString(t,u)!==y||("boolean"==typeof y&&Object.byString(t,u),!1));default:return!("object"==typeof y&&!y.includes(Object.byString(t,u)))&&(("string"!=typeof y||Object.byString(t,u)===y)&&("boolean"==typeof y&&Object.byString(t,u),!0))}}))}if(r)for(var u in r)l.sort(((t,e)=>"ASC"===r[u]?Object.byString(t,u)<Object.byString(e,u)?-1:Object.byString(t,u)>Object.byString(e,u)?1:0:Object.byString(t,u)>Object.byString(e,u)?-1:Object.byString(t,u)<Object.byString(e,u)?1:0));if(c&&l.sort(((t,e)=>Math.random()<Math.random()?-1:Math.random()>Math.random()?1:0)),0!==a&&l.length>a)for(;a>0;)l.shift(),a--;else if(l.length<a)return[];if(0!==o&&o>0)for(;l.length>o;)l.pop();return l}return[]}connectedCallback(){super.connectedCallback(),this.__disposer=i((()=>{this.routerManifest=Object.assign({},s(e.routerManifest))})),this.__disposer2=i((()=>{this.activeId=s(e.activeId)}))}disconnectedCallback(){this.__disposer(),this.__disposer2(),super.disconnectedCallback()}}globalThis.customElements.define(SiteQuery.tag,SiteQuery);export{SiteQuery};