import{LitElement as t,html as e,css as i}from"../../lit/index.js";import"./lib/loading-indicator.js";export class IframeLoader extends t{static get tag(){return"iframe-loader"}static get properties(){return{loading:{type:Boolean},height:{type:String},width:{type:String},isPDF:{type:Boolean,reflect:!0,attribute:"is-pdf"},disabled:{type:Boolean,reflect:!0},source:{type:String,reflect:!0}}}static get styles(){return i`
      :host {
        display: block;
      }
      #container {
        position: relative;
      }
      :host([disabled]) #container {
        z-index: 1;
        opacity: 0.2;
        background-color: white;
        transition: 0.3s linear all;
      }
      :host([disabled]) #container:hover {
        opacity: 0.6;
      }
      :host([disabled]) #slot {
        z-index: -1;
        pointer-events: none;
      }
      #loading-screen {
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .loaded #loading-screen {
        display: none;
      }
    `}constructor(){super(),this.isPDF=!1,this.invalidSource=!1,this.disabled=!1,this.loading=!0,this.height=500,this.width="100%",this.__iframe=null,this.querySelector("iframe")?(this.__iframe=this.querySelector("iframe"),this.__iframe.addEventListener("load",this.iframeLoadingCallback.bind(this)),this.__iframe.getAttribute("src")&&(this.source=this.__iframe.getAttribute("src"),this.height=this.__iframe.getAttribute("height")||this.height,this.width=this.__iframe.getAttribute("width")||this.width)):this.source=null,this.__mutationObserver=new MutationObserver((t=>{t.forEach((t=>{t.target.offsetHeight&&this.loading&&(this.height=t.target.offsetHeight)}))})),this.__observer=new MutationObserver((t=>{this.querySelector("iframe")&&(this.__iframe=this.querySelector("iframe"),this.source=this.__iframe.getAttribute("src"),this.__iframe.addEventListener("load",this.iframeLoadingCallback.bind(this)),this.__mutationObserver.observe(this.__iframe,{attributes:!0}))})),this.__observer.observe(this,{childList:!0}),this.querySelector("iframe-loader")&&this.querySelector("iframe-loader").remove()}iframeLoadingCallback(t){clearTimeout(this.__debounce),this.__debounce=setTimeout((()=>{this.loading=!1,t&&t.path&&t.path[0]&&t.path[0].height&&(this.height=t.path[0].height)}),500)}haxHooks(){return{preProcessNodeToContent:"haxpreProcessNodeToContent",editModeChanged:"haxeditModeChanged",activeElementChanged:"haxactiveElementChanged"}}async haxpreProcessNodeToContent(t){return t.disabled=!1,t}haxactiveElementChanged(t,e){return this.__iframe?this.source!==this.__iframe.getAttribute("src")&&(this.source=this.__iframe.getAttribute("src")):t&&t.src&&this.source!==t.src&&(this.source=t.src),this.disabled=!0,t}haxeditModeChanged(t){this.disabled=t}static get haxProperties(){return new URL(`./lib/${this.tag}.haxProperties.json`,import.meta.url).href}firstUpdated(t){super.firstUpdated&&super.firstUpdated(t),this.querySelector("iframe")||(this.__iframe=globalThis.document.createElement("iframe"),this.__iframe.setAttribute("width",this.width),this.__iframe.setAttribute("height",this.height),this.__mutationObserver.observe(this.__iframe,{attributes:!0}),this.__iframe.setAttribute("src",this.source),this.isPDF||this.__iframe.setAttribute("sandbox","allow-scripts allow-same-origin"),this.appendChild(this.__iframe)),globalThis.HaxStore&&globalThis.HaxStore.instance&&globalThis.HaxStore.instance.editMode&&(this.disabled=!0)}disconnectedCallback(){super.disconnectedCallback(),this.__iframe&&this.__iframe.removeEventListener("load",this.iframeLoadingCallback.bind(this)),this.__observer.disconnect()}updated(t){super.updated&&super.updated(t),t.forEach(((t,e)=>{this.invalidSource||("isPDF"===e&&this.__iframe?this.isPDF?this.__iframe.removeAttribute("sandbox"):this.__iframe.setAttribute("sandbox","allow-scripts allow-same-origin"):"source"===e?(this.isPDF=!1,this.source&&this.source.endsWith(".pdf")&&(this.isPDF=!0),this.__iframe?(this.isPDF?this.__iframe.removeAttribute("sandbox"):this.__iframe.setAttribute("sandbox","allow-scripts allow-same-origin"),this.__iframe.setAttribute("src",this.source)):(this.__iframe=globalThis.document.createElement("iframe"),this.__iframe.setAttribute("width",this.width),this.__iframe.setAttribute("height",this.height),this.__mutationObserver.observe(this.__iframe,{attributes:!0}),this.isPDF?this.__iframe.removeAttribute("sandbox"):this.__iframe.setAttribute("sandbox","allow-scripts allow-same-origin"),this.__iframe.setAttribute("src",this.source),this.appendChild(this.__iframe))):["height","width"].includes(e)&&this.__iframe&&this.__iframe.setAttribute(e,this[e]))}))}render(){return e`
      <div id="container" class="${this.loading?"loading":"loaded"}">
        <div id="loading-screen" style="height:${this.height}px;">
          <loading-indicator ?loading="${this.loading}"></loading-indicator>
        </div>
        <div id="slot" style="display: ${this.loading?"none":"block"}">
          <slot></slot>
        </div>
      </div>
    `}}globalThis.customElements.define(IframeLoader.tag,IframeLoader);