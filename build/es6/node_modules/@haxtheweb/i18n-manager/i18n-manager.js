/**
 * Copyright 2021 The Pennsylvania State University
 * @license Apache-2.0, see License.md for full text
 */
import{LitElement as t}from"../../lit/index.js";globalThis.I18NManagerStore=globalThis.I18NManagerStore||{},globalThis.I18NManagerStore.requestAvailability=()=>(!globalThis.I18NManagerStore.instance&&globalThis.document&&globalThis.document.body&&(globalThis.I18NManagerStore.instance=globalThis.document.createElement("i18n-manager"),globalThis.document.body.appendChild(globalThis.I18NManagerStore.instance)),globalThis.I18NManagerStore.instance);export const I18NManagerStore=globalThis.I18NManagerStore.requestAvailability();class I18NManager extends t{constructor(){super(),this.windowControllers=new AbortController,this.fetchTargets={},this.elements=[],this.locales=new Set([]),this.translationManifest=null,this.manifestLoaded=!1,this.manifestLoading=!1,this.lang=this.documentLang,this.dir=this.documentDir}get documentLang(){return globalThis.document.body.getAttribute("xml:lang")||globalThis.document.body.getAttribute("lang")||globalThis.document.documentElement.getAttribute("xml:lang")||globalThis.document.documentElement.getAttribute("lang")||globalThis.navigator.language||"en"}get documentDir(){return globalThis.document.body.getAttribute("xml:dir")||globalThis.document.body.getAttribute("dir")||globalThis.document.documentElement.getAttribute("xml:dir")||globalThis.document.documentElement.getAttribute("dir")||"ltr"}connectedCallback(){this.__ready=!0,globalThis.addEventListener("i18n-manager-register-element",this.registerLocalizationEvent.bind(this),{signal:this.windowControllers.signal}),globalThis.addEventListener("languagechange",this.changeLanguageEvent.bind(this),{signal:this.windowControllers.signal});try{this._docObserver=new MutationObserver((t=>{let e=null,a=null;t.forEach((t=>{if("attributes"===t.type){const s=t.attributeName;"lang"!==s&&"xml:lang"!==s||(e=this.documentLang),"dir"!==s&&"xml:dir"!==s||(a=this.documentDir)}})),e&&e!==this.lang&&(this.lang=e),a&&a!==this.dir&&(this.dir=a)}));const t={attributes:!0,attributeFilter:["lang","xml:lang","dir","xml:dir"]};globalThis.document&&globalThis.document.documentElement&&this._docObserver.observe(globalThis.document.documentElement,t),globalThis.document&&globalThis.document.body&&this._docObserver.observe(globalThis.document.body,t)}catch(t){console.warn("i18n-manager: Failed to start document observer",t)}}disconnectedCallback(){if(this.windowControllers.abort(),this._docObserver){try{this._docObserver.disconnect()}catch(t){}this._docObserver=null}}changeLanguageEvent(t){const e=t&&t.detail?t.detail:this.documentLang;e&&(this.lang=e)}registerLocalizationEvent(t){let e=this.detailNormalize(t.detail);e.namespace&&e.localesPath&&this.registerLocalization(e)}detailNormalize(t){if(!t.namespace&&t.context&&(t.namespace=t.context.tagName.toLowerCase()),!t.updateCallback&&t.context&&(t.context.requestUpdate?t.updateCallback="requestUpdate":t.context.render&&(t.updateCallback="render")),!t.localesPath&&t.basePath&&(t.localesPath=`${decodeURIComponent(t.basePath)}/../locales`),t.context&&t.namespace){t.context.t&&(t.context._t={...t.context.t});let e=this.elements.filter((e=>{if(e.namespace==t.namespace&&e.localesPath)return!0}));e&&e.length&&e[0]&&(t.localesPath=e[0].localesPath,e[0].locales&&(t.locales=e[0].locales))}return t}registerLocalization(t){(!t.context&&0===this.elements.filter((e=>e.namespace===t.namespace)).length||0===this.elements.filter((e=>e.context===t.context)).length)&&(t=this.detailNormalize(t),this.elements.push(t),t&&t.locales&&t.locales.forEach(this.locales.add,this.locales),this.lang&&this.__ready&&(t.locales&&t.locales.includes(this.lang)||!t.locales&&"en"!==this.lang&&!this.lang.startsWith("en-"))&&(clearTimeout(this._debounce),this._debounce=setTimeout((()=>{this.updateLanguage(this.lang)}),0)))}async loadTranslationManifest(){if(this.manifestLoaded||this.manifestLoading)return this.translationManifest;this.manifestLoading=!0;try{const t=new URL("./lib/translation-manifest.json",import.meta.url).href,e=await fetch(t);if(e.ok){const t=await e.json();this.translationManifest=t.manifest||{},this.manifestLoaded=!0}else console.warn("Translation manifest not found, falling back to component locales"),this.translationManifest={},this.manifestLoaded=!0}catch(t){console.warn("Failed to load translation manifest:",t.message),this.translationManifest={},this.manifestLoaded=!0}finally{this.manifestLoading=!1}return this.translationManifest}hasTranslation(t,e){return!(!this.manifestLoaded||!this.translationManifest)&&(this.translationManifest[t]&&this.translationManifest[t].includes(e))}needsManifest(t){return t&&"en"!==t&&!t.startsWith("en-")}static get tag(){return"i18n-manager"}async loadNamespaceFile(t,e=this.lang){const a=e.split("-");let s=this.elements.filter((e=>e.namespace===t));if(s&&s.length>=1){const i=s[0];this.needsManifest(e)&&!this.manifestLoaded&&await this.loadTranslationManifest();const l=this.hasTranslation(t,e),o=this.hasTranslation(t,a[0]),r=i.locales&&i.locales.includes(e),c=i.locales&&i.locales.includes(a[0]),h=l||!this.manifestLoaded&&r,d=o||!this.manifestLoaded&&c,g=!i.locales,m=g&&(l||o||!this.manifestLoaded);if(!h&&!d&&!m)return{};var n="";return h||g&&l?n=`${i.localesPath}/${i.namespace}.${e}.json`:d||g&&o?n=`${i.localesPath}/${i.namespace}.${a[0]}.json`:g&&!this.manifestLoaded&&(n=`${i.localesPath}/${i.namespace}.${e}.json`),""==n?{}:(this.fetchTargets[n]||(this.fetchTargets[n]=await fetch(n).then((t=>!(!t||!t.json)&&t.json()))),this.fetchTargets[n])}}async updateLanguage(t){if(t){const n=t.split("-");this.needsManifest(t)&&!this.manifestLoaded&&await this.loadTranslationManifest();const i=this.elements.filter((e=>{try{const a=this.hasTranslation(e.namespace,t),s=this.hasTranslation(e.namespace,n[0]),i=e.locales&&e.locales.includes(t),l=e.locales&&e.locales.includes(n[0]),o=!e.locales&&(this.manifestLoaded&&(a||s)||!this.manifestLoaded&&this.needsManifest(t));return a||s||i||l||o}catch(t){console.error("i18n registration incorrect in:",e,t)}})),l=this.elements.filter((e=>{try{const a=this.hasTranslation(e.namespace,t),s=this.hasTranslation(e.namespace,n[0]),i=e.locales&&e.locales.includes(t),l=e.locales&&e.locales.includes(n[0]),o=!e.locales&&(this.manifestLoaded&&(a||s)||!this.manifestLoaded&&this.needsManifest(t));return!(a||s||i||l||o)}catch(t){return!0}}));if(0!==l.length)for(var e in l){let t=l[e];t.context&&(t.context.t={...t.context._t},t.updateCallback&&t.context[t.updateCallback]())}for(var e in i){let l=i[e];var a="";const o=this.hasTranslation(l.namespace,t),r=this.hasTranslation(l.namespace,n[0]),c=l.locales&&l.locales.includes(t),h=l.locales&&l.locales.includes(n[0]),d=!l.locales;if(o||c||d&&o?a=`${l.localesPath}/${l.namespace}.${t}.json`:r||h||d&&r?a=`${l.localesPath}/${l.namespace}.${n[0]}.json`:d&&!this.manifestLoaded&&(a=`${l.localesPath}/${l.namespace}.${t}.json`),a)if(this.fetchTargets[a]){if(l.context){let t=this.fetchTargets[a];for(var s in t)l.context.t[s]=t[s];l.context.t={...l.context.t},l.updateCallback&&l.context[l.updateCallback]()}}else if(this.fetchTargets[a]=await fetch(a).then((t=>!(!t||!t.json)&&t.json())),l.context){let t=this.fetchTargets[a];for(var s in t)l.context.t[s]=t[s];l.context.t={...l.context.t},l.updateCallback&&l.context&&l.context[l.updateCallback]()}}}}static get observedAttributes(){return["lang","dir"]}attributeChangedCallback(t,e,a){"lang"!==t&&"dir"!==t||this.dispatchEvent(new CustomEvent(`${t}-changed`,{detail:{value:a}})),"lang"===t&&a&&this.__ready&&this.updateLanguage(a)}get lang(){return this.getAttribute("lang")}set lang(t){t?this.setAttribute("lang",t):this.removeAttribute("lang")}get dir(){return this.getAttribute("dir")}set dir(t){t?this.setAttribute("dir",t):this.removeAttribute("dir")}}globalThis.customElements.define(I18NManager.tag,I18NManager);export{I18NManager};